<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Ecoplantia AR Garden</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #000;
      overflow: hidden;
      touch-action: none;
    }
    
    #cameraView { position: fixed; inset: 0; background: #111; }
    #cameraVideo { width: 100%; height: 100%; object-fit: cover; }
    #plantsOverlay { position: fixed; inset: 0; pointer-events: none; }
    
    .arPlant {
      position: absolute;
      pointer-events: auto;
      touch-action: none;
      cursor: grab;
      filter: drop-shadow(0 4px 8px rgba(0,0,0,0.4));
      transition: transform 0.1s;
    }
    .arPlant.dragging { cursor: grabbing; transform: scale(1.1); z-index: 1000; }
    .arPlant.selected { outline: 3px solid #4CAF50; outline-offset: 3px; border-radius: 8px; }
    .arPlant img { width: 100%; height: 100%; object-fit: contain; pointer-events: none; }
    
    #topBar {
      position: fixed; top: 0; left: 0; right: 0;
      padding: 12px 15px;
      padding-top: max(12px, env(safe-area-inset-top));
      background: linear-gradient(to bottom, rgba(0,0,0,0.6), transparent);
      display: flex; justify-content: space-between; align-items: center;
      z-index: 10;
    }
    #topBar h3 { color: #fff; font-size: 16px; font-weight: 600; margin: 0; }
    
    .topBtn {
      background: rgba(255,255,255,0.2);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: none; color: #fff;
      width: 36px; height: 36px;
      border-radius: 50%; font-size: 18px; cursor: pointer;
    }
    .topBtn:active { background: rgba(255,255,255,0.4); }
    
    #bottomControls {
      position: fixed; bottom: 0; left: 0; right: 0;
      padding: 12px 15px;
      padding-bottom: max(12px, env(safe-area-inset-bottom));
      background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
      z-index: 10;
    }
    
    #plantTray {
      display: flex; gap: 8px; overflow-x: auto;
      padding: 8px 0; margin-bottom: 12px;
      -webkit-overflow-scrolling: touch;
    }
    #plantTray::-webkit-scrollbar { display: none; }
    
    .trayPlant {
      flex-shrink: 0; width: 55px; height: 65px;
      background: rgba(255,255,255,0.15);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 10px;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.2s;
    }
    .trayPlant:active { transform: scale(0.95); }
    .trayPlant.selected { border-color: #4CAF50; background: rgba(76,175,80,0.3); }
    .trayPlant img { width: 35px; height: 35px; object-fit: contain; }
    .trayPlant span { color: #fff; font-size: 8px; margin-top: 3px; }
    
    #actionBtns { display: flex; justify-content: center; gap: 12px; }
    
    .actionBtn {
      background: rgba(255,255,255,0.2);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: none; color: #fff;
      padding: 10px 20px; border-radius: 20px;
      font-size: 13px; font-weight: 600; cursor: pointer;
    }
    .actionBtn:active { transform: scale(0.95); }
    .actionBtn.primary { background: #4CAF50; }
    
    #sizeControls {
      position: fixed; bottom: 150px; left: 50%;
      transform: translateX(-50%);
      display: none; gap: 8px;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      padding: 6px 12px; border-radius: 20px;
      z-index: 10;
    }
    #sizeControls.vis { display: flex; }
    
    .sizeBtn {
      background: rgba(255,255,255,0.2);
      border: none; color: #fff;
      width: 32px; height: 32px;
      border-radius: 50%; font-size: 16px; cursor: pointer;
    }
    .sizeBtn:active { background: rgba(255,255,255,0.4); }
    .deleteBtn { background: rgba(244,67,54,0.8) !important; }
    
    #sizeLabel {
      color: #fff; font-size: 12px;
      min-width: 40px; text-align: center; line-height: 32px;
    }
    
    #hint {
      position: fixed; top: 70px; left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.7); color: #fff;
      padding: 8px 16px; border-radius: 16px;
      font-size: 12px; z-index: 10;
      opacity: 0; transition: opacity 0.3s;
      pointer-events: none; white-space: nowrap;
    }
    #hint.show { opacity: 1; }
    
    #permission {
      position: fixed; inset: 0;
      background: linear-gradient(135deg, #1B5E20, #4CAF50);
      display: flex; align-items: center; justify-content: center;
      z-index: 20;
    }
    #permission.hide { display: none; }
    
    .permContent { text-align: center; padding: 30px; max-width: 320px; }
    .permIcon { font-size: 60px; margin-bottom: 20px; }
    .permContent h3 { color: #fff; font-size: 24px; margin: 0 0 12px; }
    .permContent p { color: rgba(255,255,255,0.9); font-size: 14px; margin: 0 0 30px; line-height: 1.5; }
    
    .startBtn {
      background: #fff; color: #1B5E20;
      border: none; padding: 16px 40px;
      border-radius: 30px; font-size: 16px; font-weight: 700;
      cursor: pointer; margin-bottom: 15px;
      display: block; width: 100%;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    .startBtn:active { transform: scale(0.98); }
    
    .backLink {
      color: rgba(255,255,255,0.8);
      font-size: 14px;
      text-decoration: none;
      display: inline-block;
      margin-top: 10px;
    }
    
    #errorMsg {
      color: #ffcdd2; font-size: 13px;
      margin-top: 20px; line-height: 1.4;
    }
    
    #flash {
      position: fixed; inset: 0;
      background: #fff; opacity: 0;
      pointer-events: none; z-index: 100;
      transition: opacity 0.1s;
    }
    #flash.flash { opacity: 1; }
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  </style>
</head>
<body>
  <!-- Permission Screen -->
  <div id="permission">
    <div class="permContent">
      <div class="permIcon">üåø</div>
      <h3>AR Garden Preview</h3>
      <p>See how your native plants will look in your actual yard! Point your camera at the area where you want to plant.</p>
      <button class="startBtn" id="startBtn">üì∑ Start Camera</button>
      <a href="/garden-designer" class="backLink">‚Üê Back to Designer</a>
      <div id="errorMsg"></div>
    </div>
  </div>
  
  <!-- Camera View -->
  <div id="cameraView">
    <video id="cameraVideo" autoplay playsinline muted></video>
  </div>
  
  <!-- Plants Overlay -->
  <div id="plantsOverlay"></div>
  
  <!-- Size Controls -->
  <div id="sizeControls">
    <button class="sizeBtn" id="shrinkBtn">‚àí</button>
    <span id="sizeLabel">100%</span>
    <button class="sizeBtn" id="growBtn">+</button>
    <button class="sizeBtn deleteBtn" id="deleteBtn">üóë</button>
  </div>
  
  <!-- Hint -->
  <div id="hint">Select a plant, then tap to place</div>
  
  <!-- Top Bar -->
  <div id="topBar">
    <a href="/garden-designer" class="topBtn" style="text-decoration:none;display:flex;align-items:center;justify-content:center;">‚úï</a>
    <h3>üåø AR Garden</h3>
    <button class="topBtn" id="flipBtn">üîÑ</button>
  </div>
  
  <!-- Bottom Controls -->
  <div id="bottomControls">
    <div id="plantTray"></div>
    <div id="actionBtns">
      <button class="actionBtn" id="clearBtn">üóë Clear</button>
      <button class="actionBtn primary" id="captureBtn">üì∏ Capture</button>
    </div>
  </div>
  
  <!-- Capture Flash -->
  <div id="flash"></div>
  
  <script>
    // Plant data
    const PLANTS = [
      { name: 'Lanceleaf Coreopsis', acr: 'COR', img: 'https://static.wixstatic.com/media/94bd1f_48d31eb0d72044c5a798b2fd8960256a~mv2.png' },
      { name: 'Blazingstar', acr: 'LIA', img: 'https://static.wixstatic.com/media/94bd1f_b53a5d6e4fb042c585a424bea9356928~mv2.png' },
      { name: 'Purple Lovegrass', acr: 'ERA', img: 'https://static.wixstatic.com/media/94bd1f_935a7b7f12d14b1c9d71cb3122f0c1c4~mv2.png' },
      { name: 'Black-Eyed Susan', acr: 'RUD', img: 'https://static.wixstatic.com/media/94bd1f_e5d5fdb0948b4808afaf856a5020ff13~mv2.png' },
      { name: 'Purple Coneflower', acr: 'ECH', img: 'https://static.wixstatic.com/media/94bd1f_229936c40de64ae18bf2640a08e1b58a~mv2.png' },
      { name: 'Rough Goldenrod', acr: 'SOL', img: 'https://static.wixstatic.com/media/94bd1f_78ed4dc45454484f818e215a6b795305~mv2.png' },
      { name: 'Smooth Aster', acr: 'AST', img: 'https://static.wixstatic.com/media/94bd1f_6390f6e095084528ac9eb4e7e8917f2a~mv2.png' },
      { name: 'Blunt Mountain-Mint', acr: 'MMT', img: 'https://static.wixstatic.com/media/94bd1f_c877a7e1e24143ce91317966460be77b~mv2.png' },
      { name: 'Butterfly Weed', acr: 'ASC', img: 'https://static.wixstatic.com/media/94bd1f_00213b64feff49f591a7fb83fd720fbb~mv2.png' }
    ];
    
    const $ = id => document.getElementById(id);
    
    let stream = null;
    let facingMode = 'environment';
    let selectedTray = null;
    let selectedPlant = null;
    let placedPlants = [];
    
    // Build plant tray
    function buildTray() {
      const tray = $('plantTray');
      tray.innerHTML = '';
      PLANTS.forEach((p, i) => {
        const div = document.createElement('div');
        div.className = 'trayPlant';
        div.innerHTML = `<img src="${p.img}" alt="${p.name}"><span>${p.acr}</span>`;
        div.onclick = () => selectTrayPlant(i, div);
        tray.appendChild(div);
      });
    }
    
    function selectTrayPlant(index, el) {
      // Deselect placed plant
      if (selectedPlant) {
        selectedPlant.classList.remove('selected');
        selectedPlant = null;
        $('sizeControls').classList.remove('vis');
      }
      
      // Toggle tray selection
      document.querySelectorAll('.trayPlant').forEach(t => t.classList.remove('selected'));
      
      if (selectedTray === index) {
        selectedTray = null;
      } else {
        selectedTray = index;
        el.classList.add('selected');
        showHint('Tap anywhere to place ' + PLANTS[index].name);
      }
    }
    
    function showHint(msg) {
      const hint = $('hint');
      hint.textContent = msg;
      hint.classList.add('show');
      setTimeout(() => hint.classList.remove('show'), 2500);
    }
    
    // Start camera
    async function startCamera() {
      try {
        if (stream) {
          stream.getTracks().forEach(t => t.stop());
        }
        
        stream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: facingMode,
            width: { ideal: 1920 },
            height: { ideal: 1080 }
          }
        });
        
        $('cameraVideo').srcObject = stream;
        $('permission').classList.add('hide');
        showHint('Select a plant and tap to place it');
        
      } catch (err) {
        console.error('Camera error:', err);
        $('errorMsg').innerHTML = 'Camera access denied.<br>Please allow camera access in your browser settings and reload the page.';
      }
    }
    
    $('startBtn').onclick = startCamera;
    
    // Flip camera
    $('flipBtn').onclick = async () => {
      facingMode = facingMode === 'environment' ? 'user' : 'environment';
      await startCamera();
      showHint(facingMode === 'environment' ? 'Back camera' : 'Front camera');
    };
    
    // Tap to place plant
    $('plantsOverlay').onclick = (e) => {
      if (e.target !== $('plantsOverlay')) return;
      
      if (selectedTray !== null) {
        placePlant(e.clientX, e.clientY);
      } else if (selectedPlant) {
        selectedPlant.classList.remove('selected');
        selectedPlant = null;
        $('sizeControls').classList.remove('vis');
      }
    };
    
    function placePlant(x, y) {
      const plant = PLANTS[selectedTray];
      const size = 80;
      
      const el = document.createElement('div');
      el.className = 'arPlant';
      el.style.width = size + 'px';
      el.style.height = size + 'px';
      el.style.left = (x - size/2) + 'px';
      el.style.top = (y - size/2) + 'px';
      el.dataset.plantIndex = selectedTray;
      el.dataset.scale = 1;
      el.innerHTML = `<img src="${plant.img}" alt="${plant.name}">`;
      
      $('plantsOverlay').appendChild(el);
      makeDraggable(el);
      
      placedPlants.push(el);
      showHint(plant.name + ' placed!');
    }
    
    function makeDraggable(el) {
      let startX, startY, origLeft, origTop;
      let isDragging = false;
      
      el.onpointerdown = (e) => {
        e.preventDefault();
        isDragging = true;
        el.classList.add('dragging');
        el.setPointerCapture(e.pointerId);
        
        startX = e.clientX;
        startY = e.clientY;
        origLeft = parseFloat(el.style.left) || 0;
        origTop = parseFloat(el.style.top) || 0;
      };
      
      el.onpointermove = (e) => {
        if (!isDragging) return;
        el.style.left = (origLeft + e.clientX - startX) + 'px';
        el.style.top = (origTop + e.clientY - startY) + 'px';
      };
      
      el.onpointerup = (e) => {
        isDragging = false;
        el.classList.remove('dragging');
        el.releasePointerCapture(e.pointerId);
      };
      
      el.onclick = (e) => {
        e.stopPropagation();
        selectPlacedPlant(el);
      };
    }
    
    function selectPlacedPlant(el) {
      selectedTray = null;
      document.querySelectorAll('.trayPlant').forEach(t => t.classList.remove('selected'));
      
      if (selectedPlant) selectedPlant.classList.remove('selected');
      
      selectedPlant = el;
      el.classList.add('selected');
      
      const scale = parseFloat(el.dataset.scale) || 1;
      $('sizeLabel').textContent = Math.round(scale * 100) + '%';
      $('sizeControls').classList.add('vis');
    }
    
    // Size controls
    $('growBtn').onclick = () => {
      if (!selectedPlant) return;
      let scale = parseFloat(selectedPlant.dataset.scale) || 1;
      scale = Math.min(scale * 1.2, 3);
      applyScale(selectedPlant, scale);
    };
    
    $('shrinkBtn').onclick = () => {
      if (!selectedPlant) return;
      let scale = parseFloat(selectedPlant.dataset.scale) || 1;
      scale = Math.max(scale * 0.8, 0.3);
      applyScale(selectedPlant, scale);
    };
    
    function applyScale(el, scale) {
      el.dataset.scale = scale;
      const baseSize = 80;
      const newSize = baseSize * scale;
      
      const cx = parseFloat(el.style.left) + parseFloat(el.style.width)/2;
      const cy = parseFloat(el.style.top) + parseFloat(el.style.height)/2;
      
      el.style.width = newSize + 'px';
      el.style.height = newSize + 'px';
      el.style.left = (cx - newSize/2) + 'px';
      el.style.top = (cy - newSize/2) + 'px';
      
      $('sizeLabel').textContent = Math.round(scale * 100) + '%';
    }
    
    $('deleteBtn').onclick = () => {
      if (!selectedPlant) return;
      selectedPlant.remove();
      placedPlants = placedPlants.filter(p => p !== selectedPlant);
      selectedPlant = null;
      $('sizeControls').classList.remove('vis');
      showHint('Plant removed');
    };
    
    // Clear all
    $('clearBtn').onclick = () => {
      if (placedPlants.length === 0) {
        showHint('No plants to clear');
        return;
      }
      placedPlants.forEach(p => p.remove());
      placedPlants = [];
      if (selectedPlant) {
        selectedPlant = null;
        $('sizeControls').classList.remove('vis');
      }
      showHint('All plants cleared');
    };
    
    // Capture
    $('captureBtn').onclick = async () => {
      // Deselect
      if (selectedPlant) {
        selectedPlant.classList.remove('selected');
        selectedPlant = null;
      }
      $('sizeControls').classList.remove('vis');
      
      // Flash
      $('flash').classList.add('flash');
      setTimeout(() => $('flash').classList.remove('flash'), 150);
      
      try {
        const video = $('cameraVideo');
        const canvas = document.createElement('canvas');
        canvas.width = video.videoWidth || 1920;
        canvas.height = video.videoHeight || 1080;
        const ctx = canvas.getContext('2d');
        
        // Draw video frame
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        
        // Calculate scale
        const scaleX = canvas.width / window.innerWidth;
        const scaleY = canvas.height / window.innerHeight;
        
        // Draw plants
        for (const plant of placedPlants) {
          const img = plant.querySelector('img');
          const rect = plant.getBoundingClientRect();
          
          await new Promise((resolve) => {
            const tempImg = new Image();
            tempImg.crossOrigin = 'anonymous';
            tempImg.onload = () => {
              ctx.drawImage(tempImg, 
                rect.left * scaleX, 
                rect.top * scaleY, 
                rect.width * scaleX, 
                rect.height * scaleY
              );
              resolve();
            };
            tempImg.onerror = resolve;
            tempImg.src = img.src;
          });
        }
        
        // Download
        const link = document.createElement('a');
        link.download = 'ecoplantia-ar-' + Date.now() + '.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
        
        showHint('Photo saved!');
        
      } catch (e) {
        console.error('Capture failed:', e);
        showHint('Capture failed - try screenshot instead');
      }
    };
    
    // Init
    buildTray();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Ecoplantia AR Garden</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #000; overflow: hidden; touch-action: none; }
    #cameraView { position: fixed; inset: 0; background: #111; }
    #cameraVideo { width: 100%; height: 100%; object-fit: cover; }
    #plantsOverlay { position: fixed; inset: 0; pointer-events: none; }
    .arPlant { position: absolute; pointer-events: auto; touch-action: none; cursor: grab; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.4)); transition: transform 0.1s; }
    .arPlant.dragging { cursor: grabbing; transform: scale(1.1); z-index: 1000; }
    .arPlant.selected { outline: 3px solid #4CAF50; outline-offset: 3px; border-radius: 8px; }
    .arPlant img { width: 100%; height: 100%; object-fit: contain; pointer-events: none; }
    #topBar { position: fixed; top: 0; left: 0; right: 0; padding: 12px 15px; padding-top: max(12px, env(safe-area-inset-top)); background: linear-gradient(to bottom, rgba(0,0,0,0.6), transparent); display: flex; justify-content: space-between; align-items: center; z-index: 10; }
    #topBar h3 { color: #fff; font-size: 16px; font-weight: 600; margin: 0; }
    .topBtn { background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); border: none; color: #fff; width: 36px; height: 36px; border-radius: 50%; font-size: 18px; cursor: pointer; }
    #bottomControls { position: fixed; bottom: 0; left: 0; right: 0; padding: 12px 15px; padding-bottom: max(12px, env(safe-area-inset-bottom)); background: linear-gradient(to top, rgba(0,0,0,0.8), transparent); z-index: 10; }
    #plantTray { display: flex; gap: 8px; overflow-x: auto; padding: 8px 0; margin-bottom: 12px; -webkit-overflow-scrolling: touch; }
    #plantTray::-webkit-scrollbar { display: none; }
    .trayPlant { flex-shrink: 0; width: 55px; height: 65px; background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); border-radius: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; border: 2px solid transparent; transition: all 0.2s; }
    .trayPlant.selected { border-color: #4CAF50; background: rgba(76,175,80,0.3); }
    .trayPlant img { width: 35px; height: 35px; object-fit: contain; }
    .trayPlant span { color: #fff; font-size: 8px; margin-top: 3px; }
    #actionBtns { display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
    .actionBtn { background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); border: none; color: #fff; padding: 10px 16px; border-radius: 20px; font-size: 12px; font-weight: 600; cursor: pointer; }
    .actionBtn.primary { background: #4CAF50; }
    .actionBtn.back { background: rgba(33,150,243,0.8); }
    #sizeControls { position: fixed; bottom: 170px; left: 50%; transform: translateX(-50%); display: none; gap: 8px; background: rgba(0,0,0,0.7); backdrop-filter: blur(10px); padding: 6px 12px; border-radius: 20px; z-index: 10; }
    #sizeControls.vis { display: flex; }
    .sizeBtn { background: rgba(255,255,255,0.2); border: none; color: #fff; width: 32px; height: 32px; border-radius: 50%; font-size: 16px; cursor: pointer; }
    .deleteBtn { background: rgba(244,67,54,0.8) !important; }
    #sizeLabel { color: #fff; font-size: 12px; min-width: 40px; text-align: center; line-height: 32px; }
    #hint { position: fixed; top: 70px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); color: #fff; padding: 8px 16px; border-radius: 16px; font-size: 12px; z-index: 10; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
    #hint.show { opacity: 1; }
    #permission { position: fixed; inset: 0; background: linear-gradient(135deg, #1B5E20, #4CAF50); display: flex; align-items: center; justify-content: center; z-index: 20; }
    #permission.hide { display: none; }
    .permContent { text-align: center; padding: 30px; max-width: 320px; }
    .permIcon { font-size: 50px; margin-bottom: 15px; }
    .permContent h3 { color: #fff; font-size: 22px; margin: 0 0 10px; }
    .permContent p { color: rgba(255,255,255,0.9); font-size: 13px; margin: 0 0 20px; line-height: 1.5; }
    .plantCount { background: rgba(255,255,255,0.2); padding: 10px 15px; border-radius: 10px; margin-bottom: 20px; color: #fff; font-size: 14px; }
    .startBtn { background: #fff; color: #1B5E20; border: none; padding: 14px 35px; border-radius: 25px; font-size: 15px; font-weight: 700; cursor: pointer; margin-bottom: 12px; display: block; width: 100%; }
    .closePermBtn { background: transparent; color: rgba(255,255,255,0.8); border: 2px solid rgba(255,255,255,0.5); padding: 10px 25px; border-radius: 20px; font-size: 13px; cursor: pointer; display: block; width: 100%; }
    #errorMsg { color: #ffcdd2; font-size: 12px; margin-top: 15px; }
    #flash { position: fixed; inset: 0; background: #fff; opacity: 0; pointer-events: none; z-index: 100; transition: opacity 0.1s; }
    #flash.flash { opacity: 1; }
  </style>
</head>
<body>
  <div id="permission">
    <div class="permContent">
      <div class="permIcon">üì±</div>
      <h3>AR Garden Preview</h3>
      <p>See how your plants will look in your actual yard!</p>
      <div class="plantCount" id="plantCount">Select plants below and place them in your view</div>
      <button class="startBtn" id="startBtn">üì∑ Start Camera</button>
      <button class="closePermBtn" onclick="history.back()">‚Üê Back</button>
      <div id="errorMsg"></div>
    </div>
  </div>
  <div id="cameraView"><video id="cameraVideo" autoplay playsinline muted></video></div>
  <div id="plantsOverlay"></div>
  <div id="sizeControls">
    <button class="sizeBtn" id="shrinkBtn">‚àí</button>
    <span id="sizeLabel">100%</span>
    <button class="sizeBtn" id="growBtn">+</button>
    <button class="sizeBtn deleteBtn" id="deleteBtn">üóë</button>
  </div>
  <div id="hint"></div>
  <div id="topBar" style="display:none">
    <button class="topBtn" onclick="history.back()">‚Üê</button>
    <h3>üåø AR Garden</h3>
    <button class="topBtn" id="flipBtn">üîÑ</button>
  </div>
  <div id="bottomControls" style="display:none">
    <div id="plantTray"></div>
    <div id="actionBtns">
      <button class="actionBtn back" onclick="history.back()">‚Üê Back</button>
      <button class="actionBtn" id="clearBtn">üóë</button>
      <button class="actionBtn primary" id="captureBtn">üì∏ Capture</button>
    </div>
  </div>
  <div id="flash"></div>
  
  <script>
    const PLANTS = [
      { name: 'Lanceleaf Coreopsis', acr: 'COR', img: 'https://static.wixstatic.com/media/94bd1f_48d31eb0d72044c5a798b2fd8960256a~mv2.png' },
      { name: 'Blazingstar', acr: 'LIA', img: 'https://static.wixstatic.com/media/94bd1f_b53a5d6e4fb042c585a424bea9356928~mv2.png' },
      { name: 'Purple Lovegrass', acr: 'ERA', img: 'https://static.wixstatic.com/media/94bd1f_935a7b7f12d14b1c9d71cb3122f0c1c4~mv2.png' },
      { name: 'Black-Eyed Susan', acr: 'RUD', img: 'https://static.wixstatic.com/media/94bd1f_e5d5fdb0948b4808afaf856a5020ff13~mv2.png' },
      { name: 'Purple Coneflower', acr: 'ECH', img: 'https://static.wixstatic.com/media/94bd1f_229936c40de64ae18bf2640a08e1b58a~mv2.png' },
      { name: 'Rough Goldenrod', acr: 'SOL', img: 'https://static.wixstatic.com/media/94bd1f_78ed4dc45454484f818e215a6b795305~mv2.png' },
      { name: 'Smooth Aster', acr: 'AST', img: 'https://static.wixstatic.com/media/94bd1f_6390f6e095084528ac9eb4e7e8917f2a~mv2.png' },
      { name: 'Blunt Mountain-Mint', acr: 'MMT', img: 'https://static.wixstatic.com/media/94bd1f_c877a7e1e24143ce91317966460be77b~mv2.png' },
      { name: 'Butterfly Weed', acr: 'ASC', img: 'https://static.wixstatic.com/media/94bd1f_00213b64feff49f591a7fb83fd720fbb~mv2.png' }
    ];
    
    let DESIGN_PLANTS = [];
    try {
      const hash = window.location.hash.slice(1);
      if (hash) {
        DESIGN_PLANTS = JSON.parse(decodeURIComponent(hash));
        document.getElementById('plantCount').textContent = DESIGN_PLANTS.length + ' plants from your design';
      }
    } catch(e) {}
    
    const $ = id => document.getElementById(id);
    let stream = null, facingMode = 'environment';
    let selectedTray = null, selectedPlant = null, placedPlants = [];
    
    const tray = $('plantTray');
    PLANTS.forEach((p, i) => {
      const d = document.createElement('div');
      d.className = 'trayPlant';
      d.innerHTML = '<img src="' + p.img + '"><span>' + p.acr + '</span>';
      d.onclick = () => {
        if (selectedPlant) { selectedPlant.classList.remove('selected'); selectedPlant = null; $('sizeControls').classList.remove('vis'); }
        document.querySelectorAll('.trayPlant').forEach(t => t.classList.remove('selected'));
        if (selectedTray === i) { selectedTray = null; } else { selectedTray = i; d.classList.add('selected'); showHint('Tap to place ' + p.name); }
      };
      tray.appendChild(d);
    });
    
    function showHint(msg) { $('hint').textContent = msg; $('hint').classList.add('show'); setTimeout(() => $('hint').classList.remove('show'), 2500); }
    
    $('startBtn').onclick = startCamera;
    async function startCamera() {
      try {
        if (stream) stream.getTracks().forEach(t => t.stop());
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode, width: { ideal: 1920 }, height: { ideal: 1080 } } });
        $('cameraVideo').srcObject = stream;
        $('permission').classList.add('hide');
        $('topBar').style.display = 'flex';
        $('bottomControls').style.display = 'block';
        setTimeout(placeDesignPlants, 500);
      } catch (e) {
        $('errorMsg').textContent = 'Camera denied. Check browser settings.';
      }
    }
    
    function placeDesignPlants() {
      if (!DESIGN_PLANTS.length) { showHint('Select a plant and tap to place'); return; }
      const w = innerWidth, h = innerHeight;
      DESIGN_PLANTS.forEach(dp => {
        const plant = PLANTS[dp.idx]; if (!plant) return;
        const size = 70, x = w*0.1 + dp.relX*w*0.8, y = h*0.35 + dp.relY*h*0.35;
        const el = document.createElement('div');
        el.className = 'arPlant';
        el.style.cssText = 'width:'+size+'px;height:'+size+'px;left:'+(x-size/2)+'px;top:'+(y-size/2)+'px';
        el.dataset.scale = 1;
        el.innerHTML = '<img src="' + plant.img + '">';
        $('plantsOverlay').appendChild(el);
        makeDrag(el);
        placedPlants.push(el);
      });
      showHint(DESIGN_PLANTS.length + ' plants placed!');
    }
    
    $('flipBtn').onclick = async () => { facingMode = facingMode === 'environment' ? 'user' : 'environment'; await startCamera(); };
    
    $('plantsOverlay').onclick = (e) => {
      if (e.target !== $('plantsOverlay')) return;
      if (selectedTray !== null) {
        const p = PLANTS[selectedTray], size = 70;
        const el = document.createElement('div');
        el.className = 'arPlant';
        el.style.cssText = 'width:'+size+'px;height:'+size+'px;left:'+(e.clientX-size/2)+'px;top:'+(e.clientY-size/2)+'px';
        el.dataset.scale = 1;
        el.innerHTML = '<img src="' + p.img + '">';
        $('plantsOverlay').appendChild(el);
        makeDrag(el);
        placedPlants.push(el);
        showHint(p.name + ' placed!');
      } else if (selectedPlant) {
        selectedPlant.classList.remove('selected'); selectedPlant = null; $('sizeControls').classList.remove('vis');
      }
    };
    
    function makeDrag(el) {
      let sx, sy, ox, oy, drag = false;
      el.onpointerdown = e => { e.preventDefault(); drag = true; el.classList.add('dragging'); el.setPointerCapture(e.pointerId); sx = e.clientX; sy = e.clientY; ox = parseFloat(el.style.left); oy = parseFloat(el.style.top); };
      el.onpointermove = e => { if (!drag) return; el.style.left = (ox + e.clientX - sx) + 'px'; el.style.top = (oy + e.clientY - sy) + 'px'; };
      el.onpointerup = e => { drag = false; el.classList.remove('dragging'); el.releasePointerCapture(e.pointerId); };
      el.onclick = e => { e.stopPropagation(); selectPlant(el); };
    }
    
    function selectPlant(el) {
      selectedTray = null; document.querySelectorAll('.trayPlant').forEach(t => t.classList.remove('selected'));
      if (selectedPlant) selectedPlant.classList.remove('selected');
      selectedPlant = el; el.classList.add('selected');
      $('sizeLabel').textContent = Math.round((parseFloat(el.dataset.scale) || 1) * 100) + '%';
      $('sizeControls').classList.add('vis');
    }
    
    function applyScale(el, s) {
      el.dataset.scale = s; const ns = 70 * s;
      const cx = parseFloat(el.style.left) + parseFloat(el.style.width)/2;
      const cy = parseFloat(el.style.top) + parseFloat(el.style.height)/2;
      el.style.width = ns + 'px'; el.style.height = ns + 'px';
      el.style.left = (cx - ns/2) + 'px'; el.style.top = (cy - ns/2) + 'px';
      $('sizeLabel').textContent = Math.round(s * 100) + '%';
    }
    
    $('growBtn').onclick = () => { if (selectedPlant) applyScale(selectedPlant, Math.min((parseFloat(selectedPlant.dataset.scale)||1)*1.2, 3)); };
    $('shrinkBtn').onclick = () => { if (selectedPlant) applyScale(selectedPlant, Math.max((parseFloat(selectedPlant.dataset.scale)||1)*0.8, 0.3)); };
    $('deleteBtn').onclick = () => { if (selectedPlant) { selectedPlant.remove(); placedPlants = placedPlants.filter(p => p !== selectedPlant); selectedPlant = null; $('sizeControls').classList.remove('vis'); showHint('Removed'); } };
    $('clearBtn').onclick = () => { placedPlants.forEach(p => p.remove()); placedPlants = []; showHint('Cleared'); };
    
    $('captureBtn').onclick = async () => {
      if (selectedPlant) { selectedPlant.classList.remove('selected'); selectedPlant = null; }
      $('sizeControls').classList.remove('vis');
      $('flash').classList.add('flash'); setTimeout(() => $('flash').classList.remove('flash'), 150);
      try {
        const v = $('cameraVideo'), c = document.createElement('canvas');
        c.width = v.videoWidth || 1920; c.height = v.videoHeight || 1080;
        const ctx = c.getContext('2d');
        ctx.drawImage(v, 0, 0, c.width, c.height);
        const sx = c.width / innerWidth, sy = c.height / innerHeight;
        for (const p of placedPlants) {
          const r = p.getBoundingClientRect();
          await new Promise(res => { const i = new Image(); i.crossOrigin = 'anonymous'; i.onload = () => { ctx.drawImage(i, r.left*sx, r.top*sy, r.width*sx, r.height*sy); res(); }; i.onerror = res; i.src = p.querySelector('img').src; });
        }
        const a = document.createElement('a'); a.download = 'ecoplantia-ar.png'; a.href = c.toDataURL('image/png'); a.click();
        showHint('Saved!');
      } catch (e) { showHint('Capture failed'); }
    };
  </script>
</body>
</html>
